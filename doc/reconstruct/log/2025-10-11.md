2025-10-11

Summary

- Bootstrapped the reconstruction documentation system under doc/reconstruct.
- Captured the strangler approach in ADR 0001 and outlined milestones in plan.md.
- Completed Foundations-2 Slice 1: typed env, lazy OpenAI, centralized guards, rate limiting, user orders API.

Details (Foundations-2 Slice 1)

- Env typing
  - Added non-throwing typed getters: src/lib/config/env.ts
  - Updated example with OPENAI_API_KEY_USER: .env.example
- OpenAI refactor
  - Lazy, role-aware client; removed import-time throw and global client: src/lib/openai.ts
  - Updated createChatCompletion/createVisionChatCompletion to use chat.completions.create.
- Auth guards
  - Added assertUser/assertAdmin + UnauthorizedError: src/lib/security/guards.ts
  - Applied to admin manual book routes and function-call route.
- Rate limiting (upgraded)
  - Introduced Upstash sliding window and concurrency semaphore:
    - Policies: src/lib/security/limits.ts (new)
    - Engine: src/lib/security/ratelimit.ts (checkRateLimit, rateLimitHeaders, acquireConcurrency, releaseConcurrency)
  - Applied to heavy routes with X-RateLimit-\* headers:
    - src/app/api/admin/ai-chat/route.ts
    - src/app/api/upload/route.ts
- Orders API
  - Implemented: src/app/api/orders/user/route.ts used by src/app/users/orders/page.tsx

Validation Notes

- npm environment set up (Node 20); dependencies install successfully.
- Build compiles, but ESLint config and prisma seed typing need follow-up:
  - ESLint: Failed to load config "next/typescript" from .eslintrc.json
  - Type error: prisma/seed.ts imports CategoryType which is not exported by @prisma/client
  - These are unrelated to this slice; track as build hygiene tasks.

Next Actions

- Prepare Admin AI Hardening slice (jobs, validation, retries):
  - Add zod schemas for admin tools; validate in function-call route.
  - Add rate limit to function-call route if needed (policy-driven).
  - Design job queue interface for long-running vision/duplicate checks.

Notes

- Keep changes small and reversible; verify with runbooks/validate-foundations-slice-1.md.
