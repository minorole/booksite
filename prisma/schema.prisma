generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector]
}

model User {
  id              String            @id
  email           String            @unique
  name            String?
  role            Role              @default(USER)
  created_at      DateTime          @default(now())
  last_order_date DateTime?
  orders          Order[]
  addresses       ShippingAddress[]
}

model Book {
  id             String                 @id @default(uuid())
  title_en       String
  title_zh       String
  description_en String
  description_zh String
  cover_image    String?
  quantity       Int                    @default(0)
  category_id    String
  created_at     DateTime               @default(now())
  updated_at     DateTime               @updatedAt
  search_tags    String[]
  ai_metadata    Json?
  views          Int                    @default(0)
  embedding      Unsupported("vector")?
  category       Category               @relation(fields: [category_id], references: [id])
  order_items    OrderItem[]

  @@index([category_id])
}

model Category {
  id      String       @id @default(uuid())
  name_en String
  name_zh String
  type    CategoryType @unique
  books   Book[]
}

model Order {
  id                  String          @id @default(uuid())
  user_id             String
  status              OrderStatus     @default(PENDING)
  created_at          DateTime        @default(now())
  notes               String?
  override_by         String?
  override_monthly    Boolean         @default(false)
  shipping_address_id String
  total_items         Int
  address             ShippingAddress @relation(fields: [shipping_address_id], references: [id])
  user                User            @relation(fields: [user_id], references: [id])
  order_items         OrderItem[]

  @@index([user_id])
  @@index([shipping_address_id])
}

model OrderItem {
  order_id String
  quantity Int
  book_id  String
  book     Book   @relation(fields: [book_id], references: [id])
  order    Order  @relation(fields: [order_id], references: [id])

  @@id([order_id, book_id])
}

model ShippingAddress {
  id       String  @id @default(uuid())
  user_id  String
  address1 String
  address2 String?
  city     String
  state    String
  zip      String
  country  String
  is_valid Boolean @default(false)
  orders   Order[]
  user     User    @relation(fields: [user_id], references: [id])

  @@index([user_id])
}

model AdminLog {
  id          String      @id @default(uuid())
  action      AdminAction
  book_id     String
  book_title  String
  admin_email String
  created_at  DateTime    @default(now())
  metadata    Json?
}

enum CategoryType {
  PURE_LAND_BOOKS
  OTHER_BOOKS
  DHARMA_ITEMS
  BUDDHA_STATUES
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  SHIPPED
}

enum AdminAction {
  DELETE_BOOK
  EDIT_BOOK
}
