// Cleaned schema.prisma file
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector]
}

model User {
  id              String            @id
  email           String            @unique
  name            String?
  role            Role              @default(USER)
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  last_order_date DateTime?
  language_preference String?        // For bilingual interface
  orders          Order[]
  addresses       ShippingAddress[]
  cart            Cart[]
  chat_sessions   UserChatSession[]

  @@index([email])
  @@index([role])
}

model Book {
  id                    String          @id @default(uuid())
  title_zh             String          // Chinese title 
  title_en             String?         // English title 
  description_zh       String
  description_en       String?
  cover_image          String?
  quantity             Int              @default(0)
  category_id          String
  created_at           DateTime         @default(now())
  updated_at           DateTime         @updatedAt
  has_english_translation Boolean       @default(false)
  search_tags          String[]         @default([])    // Approved tags
  pending_tags         String[]         @default([])    // Awaiting approval
  rejected_tags        String[]         @default([])    // Explicitly rejected
  auto_tags            String[]         // LLM generated tags
  ai_metadata          Json?            // General AI metadata
  image_analysis_data  Json?            // GPT-4o image analysis results
  similar_books        String[]         // IDs of similar books detected by LLM
  views                Int              @default(0)
  embedding            Unsupported("vector")?
  discontinued         Boolean          @default(false)
  discontinued_at      DateTime?
  discontinued_by      String?
  discontinued_reason  String?
  last_quantity_update DateTime?
  last_llm_analysis    DateTime?
  content_summary_zh   String?
  content_summary_en   String?
  author_zh            String?
  author_en            String?
  publisher_zh         String?
  publisher_en         String?
  
  category             Category         @relation(fields: [category_id], references: [id])
  order_items          OrderItem[]
  cart_items           CartItem[]
  analyses             BookAnalysis[]
  tag_history          TagHistory[]

  @@index([category_id])
  @@index([similar_books])
  @@index([search_tags])
  @@index([discontinued])
}

model BookAnalysis {
  id              String        @id @default(uuid())
  book_id         String
  analysis_type   AnalysisType
  prompt_used     String
  result          Json
  confidence      Float
  created_at      DateTime      @default(now())
  admin_email     String?
  prompt_version  Int
  book            Book          @relation(fields: [book_id], references: [id])

  @@index([book_id])
  @@index([analysis_type])
  @@index([created_at])
}

model Category {
  id              String       @id @default(uuid())
  name_en         String
  name_zh         String
  type            CategoryType @unique
  description_en  String?
  description_zh  String?
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  books           Book[]

  @@index([type])
}

model Order {
  id                    String          @id @default(uuid())
  user_id               String
  status                OrderStatus     @default(PENDING)
  created_at            DateTime        @default(now())
  updated_at            DateTime        @updatedAt
  notes                 String?
  admin_notes           String?
  override_by           String?
  override_monthly      Boolean         @default(false)
  shipping_address_id   String
  total_items           Int
  tracking_number       String?
  processed_by          String?
  processing_started_at DateTime?
  llm_processing_log    Json?
  address               ShippingAddress @relation(fields: [shipping_address_id], references: [id])
  user                  User            @relation(fields: [user_id], references: [id])
  order_items           OrderItem[]

  @@index([user_id])
  @@index([shipping_address_id])
  @@index([status])
  @@index([created_at])
}

model OrderItem {
  order_id    String
  quantity    Int
  book_id     String
  added_at    DateTime  @default(now())
  book        Book      @relation(fields: [book_id], references: [id])
  order       Order     @relation(fields: [order_id], references: [id])

  @@id([order_id, book_id])
  @@index([book_id])
}

model Cart {
  id            String      @id @default(uuid())
  user_id       String
  created_at    DateTime    @default(now())
  updated_at    DateTime    @updatedAt
  expires_at    DateTime
  items         CartItem[]
  user          User        @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([expires_at])
}

model CartItem {
  cart_id     String
  book_id     String
  quantity    Int
  added_at    DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  cart        Cart      @relation(fields: [cart_id], references: [id])
  book        Book      @relation(fields: [book_id], references: [id])

  @@id([cart_id, book_id])
  @@index([book_id])
}

model ShippingAddress {
  id              String    @id @default(uuid())
  user_id         String
  address1        String
  address2        String?
  city            String
  state           String
  zip             String
  country         String    @default("US")
  is_valid        Boolean   @default(false)
  validation_log  Json?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  orders          Order[]
  user            User      @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([country])
}

model AdminChatSession {
  id                   String        @id @default(uuid())
  admin_email          String
  created_at           DateTime      @default(now())
  last_activity        DateTime      @default(now())
  context              Json?
  current_books        String[]      // For tracking books in current conversation
  current_orders       String[]      // For tracking orders in current conversation
  session_type         SessionType
  last_command         Json?         // Store last executed command
  conversation_history Json?         // Full conversation history
  tag_operations      Json?         // Track tag-related operations
  confidence_threshold Float?        // For LLM decision confidence
  auto_approve_tags   Boolean       @default(false)  // For automatic tag approval
  active              Boolean       @default(true)
  prompt_version      Int?          // Add this field to track prompt versions
  llm_settings        Json?         // Add this field for custom LLM settings

  @@index([admin_email])
  @@index([session_type])
  @@index([last_activity])
}

model UserChatSession {
  id                  String    @id @default(uuid())
  user_id             String
  created_at          DateTime  @default(now())
  last_activity       DateTime  @default(now())
  context             Json?
  current_books       String[]
  conversation_history Json?
  language_preference String?
  active              Boolean   @default(true)
  user                User      @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([last_activity])
}

model TagHistory {
  id              String    @id @default(uuid())
  book_id         String
  tag             String
  is_auto         Boolean
  added_by        String
  added_at        DateTime  @default(now())
  approved        Boolean   @default(false)
  approved_by     String?
  approved_at     DateTime?
  confidence      Float?
  prompt_version  Int
  book            Book      @relation(fields: [book_id], references: [id])

  @@index([book_id])
  @@index([tag])
  @@index([added_at])
}

model AdminLog {
  id              String       @id @default(uuid())
  action          AdminAction
  book_id         String?
  book_title      String?
  admin_email     String
  created_at      DateTime     @default(now())
  metadata        Json?
  llm_context     Json?
  related_items   String[]
  confidence      Float?
  session_id      String?
  prompt_version  Int?

  @@index([admin_email])
  @@index([action])
  @@index([created_at])
}

model SystemSettings {
  id              String    @id @default(uuid())
  key             String    @unique
  value           Json
  updated_at      DateTime  @updatedAt
  updated_by      String?
  description     String?
  
  @@index([key])
}

model SystemPrompt {
  id              String    @id @default(uuid())
  name            String    @unique
  prompt_text     String
  use_case        String
  version         Int       @default(1)
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  created_by      String?
  performance_metrics Json? // Add this field to track prompt performance

  @@index([name])
  @@index([use_case])
  @@index([version])
}

enum CategoryType {
  PURE_LAND_BOOKS
  OTHER_BOOKS
  DHARMA_ITEMS
  BUDDHA_STATUES
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  COMPLETED
  CANCELLED
}

enum AdminAction {
  DELETE_BOOK
  EDIT_BOOK
  CREATE_BOOK
  UPDATE_QUANTITY
  UPDATE_STATUS
  PROCESS_ORDER
  CANCEL_ORDER
  MARK_SHIPPED
  UPDATE_TRACKING
  ANALYZE_IMAGE
  CHECK_DUPLICATE
  APPROVE_TAG
  REJECT_TAG
  UPDATE_TAGS
  OVERRIDE_MONTHLY_LIMIT
  UPDATE_SYSTEM_SETTINGS
  UPDATE_PROMPTS
  CHAT_MESSAGE
  LLM_REQUEST
  LLM_RESPONSE
  FUNCTION_CALL
  FUNCTION_SUCCESS
  CONFIDENCE_CHECK_FAILED
  CHAT_COMPLETE
  LLM_RETRY
}

enum AnalysisType {
  IMAGE_ANALYSIS
  DUPLICATE_CHECK
  CATEGORY_SUGGESTION
  CONTENT_SUMMARY
  TAG_GENERATION
  TRANSLATION_CHECK
  SIMILARITY_CHECK
  LANGUAGE_DETECTION
}

enum SessionType {
  INVENTORY_MANAGEMENT
  ORDER_PROCESSING
  CUSTOMER_SERVICE
  GENERAL
}